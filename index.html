<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DIRI-Penpal Diary</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap');
        body { font-family: 'Gowun Dodum', sans-serif; background-color: #F7F4EB; margin: 0; color: #5D4037; overflow: hidden; }
        .app-shell { width: 100%; max-width: 480px; height: 100vh; background-color: #F7F4EB; display: flex; flex-direction: column; margin: 0 auto; position: relative; }
        .main-content { flex: 1; overflow-y: auto; padding-bottom: 90px; }
        .bottom-nav { position: absolute; bottom: 0; width: 100%; height: 80px; background: #F7F4EB; display: flex; justify-content: space-around; align-items: center; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .ddb-card { background: white; border-radius: 30px; padding: 25px; box-shadow: 0 10px 30px rgba(141, 110, 99, 0.05); }
        .lined-paper { background-image: linear-gradient(transparent 39px, #eee 40px); background-size: 100% 40px; line-height: 40px; border: none; resize: none; width: 100%; height: 400px; font-size: 18px; outline: none; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; color: #A1887F; transition: all 0.2s; }
        .nav-item.active { color: #5D4037; font-weight: bold; }
        .nav-item.active .icon-circle { background: #EFEBE9; }
        .icon-circle { width: 50px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 20px; margin-bottom: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBhgHe856C8jJUsW_3gjJSOO3mlQXDee-c",
            authDomain: "diri-penpal-diary.firebaseapp.com",
            projectId: "diri-penpal-diary",
            storageBucket: "diri-penpal-diary.firebasestorage.app",
            messagingSenderId: "587612499384",
            appId: "1:587612499384:web:8c1f491372cb112050334d"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ê¹ƒí—ˆë¸Œ ë ˆí¬ì§€í† ë¦¬ ê²½ë¡œ í™•ì¸ í•„ìˆ˜
        const STAMP_BASE_URL = "https://raw.githubusercontent.com/gkvanadil-ui/pen-pal-diary/main/stamps/";

        const App = () => {
            const [user, setUser] = useState(null);
            const [isBooting, setIsBooting] = useState(true);
            const [activeTab, setActiveTab] = useState('today');
            const [data, setData] = useState({ letters: [], trackers: [], fortunes: [] });
            const [settings, setSettings] = useState({ 
                userName: 'ë‚˜ì˜ ì´ë¦„', characterName: 'íˆìš”ë¦¬', apiKey: '', persona: '', profileImg: '',
                replyMode: 'ë°”ë¡œ', fixedDelay: 10, randomMin: 5, randomMax: 30, hasSeenGuide: false
            });

            const loadData = useCallback(async (uid) => {
                const [l, t, f] = await Promise.all([
                    db.collection('users').doc(uid).collection('letters').orderBy('date', 'desc').get(),
                    db.collection('users').doc(uid).collection('trackers').orderBy('date', 'desc').limit(1).get(),
                    db.collection('users').doc(uid).collection('fortunes').orderBy('date', 'desc').get()
                ]);
                setData({
                    letters: l.docs.map(d => ({id: d.id, ...d.data()})),
                    trackers: t.docs.map(d => ({id: d.id, ...d.data()})),
                    fortunes: f.docs.map(d => ({id: d.id, ...d.data()}))
                });
            }, []);

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        const doc = await db.collection('users').doc(u.uid).get();
                        if (doc.exists) setSettings(prev => ({...prev, ...doc.data().settings}));
                        await loadData(u.uid);
                    }
                    setIsBooting(false);
                });
                return unsub;
            }, [loadData]);

            if (isBooting) return null;
            if (!user) return <Login onLogin={() => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())} />;

            const todayTracker = data.trackers[0];

            return (
                <div className="app-shell">
                    <div className="main-content">
                        {activeTab === 'today' && <div className="p-6">ì˜¤ëŠ˜ì˜ ëŒ€í™” UI ì¤€ë¹„ ì¤‘...</div>}
                        {activeTab === 'tracker' && <TrackerView user={user} onSave={() => loadData(user.uid)} onGoCalendar={() => setActiveTab('calendar')} />}
                        {activeTab === 'write' && <LetterWrite user={user} settings={settings} tracker={todayTracker} onSent={() => loadData(user.uid)} />}
                        {activeTab === 'calendar' && <CalendarView letters={data.letters} />}
                        {activeTab === 'settings' && <div className="p-6">ì„¤ì • í˜ì´ì§€</div>}
                    </div>

                    <div className="bottom-nav">
                        <NavItem icon="fa-mobile-screen" label="ì˜¤ëŠ˜" active={activeTab==='today'} onClick={()=>setActiveTab('today')} />
                        <NavItem icon="fa-clipboard-list" label="ê¸°ë¡" active={activeTab==='tracker'} onClick={()=>setActiveTab('tracker')} />
                        <NavItem icon="fa-pen-nib" label="í¸ì§€" active={activeTab==='write'} onClick={()=>setActiveTab('write')} />
                        <NavItem icon="fa-calendar" label="ìº˜ë¦°ë”" active={activeTab==='calendar'} onClick={()=>setActiveTab('calendar')} />
                        <NavItem icon="fa-ellipsis" label="More" active={activeTab==='settings'} onClick={()=>setActiveTab('settings')} />
                    </div>
                </div>
            );
        };

        const NavItem = ({ icon, label, active, onClick }) => (
            <button onClick={onClick} className={`nav-item ${active ? 'active' : ''}`}>
                <div className="icon-circle"><i className={`fa-solid ${icon} text-xl`}></i></div>
                <span className="text-[11px]">{label}</span>
            </button>
        );

        // ê¸°ë¡ íƒ­ (ìŠ¤ìƒ· ë°˜ì˜)
        const TrackerView = ({ user, onSave, onGoCalendar }) => {
            const [form, setForm] = useState({ mood: 'ë³´í†µ', condition: 'ë³´í†µ', exercise: 'ì•ˆí•¨', weather: 'ë§‘ìŒ', sleep: 7.0 });
            const save = async () => {
                await db.collection('users').doc(user.uid).collection('trackers').add({ ...form, date: new Date().toISOString() });
                alert("ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                onSave();
            };
            return (
                <div className="p-6 space-y-6">
                    <h2 className="text-center text-xl font-bold mt-4">ì˜¤ëŠ˜ì˜ ê¸°ë¡</h2>
                    <div className="ddb-card space-y-5">
                        <div className="flex justify-between items-center border-b pb-4"><span>â˜ï¸ ê¸°ë¶„</span><span className="bg-gray-50 px-3 py-1 rounded-lg text-sm">{form.mood}</span></div>
                        <div className="flex justify-between items-center border-b pb-4"><span>ğŸŒ¡ï¸ ì»¨ë””ì…˜</span><span className="bg-gray-50 px-3 py-1 rounded-lg text-sm">{form.condition}</span></div>
                        <div className="flex justify-between items-center border-b pb-4"><span>ğŸƒ ìš´ë™</span><span className="bg-gray-50 px-3 py-1 rounded-lg text-sm">{form.exercise}</span></div>
                        <div className="flex justify-between items-center border-b pb-4"><span>â˜€ï¸ ë‚ ì”¨</span><span className="bg-gray-50 px-3 py-1 rounded-lg text-sm">{form.weather}</span></div>
                        <div className="space-y-3">
                            <div className="flex justify-between"><span>ğŸŒ™ ìˆ˜ë©´ ì‹œê°„</span><span className="font-bold">{form.sleep}h</span></div>
                            <input type="range" min="0" max="12" step="0.5" className="w-full accent-[#A1887F]" value={form.sleep} onChange={e=>setForm({...form, sleep: e.target.value})} />
                        </div>
                    </div>
                    <button onClick={save} className="w-full bg-[#8D7B71] text-white py-5 rounded-2xl font-bold shadow-lg">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
                    <button onClick={onGoCalendar} className="w-full bg-white border border-gray-200 py-4 rounded-2xl flex items-center justify-center gap-2 shadow-sm text-gray-500">
                        <i className="fa-solid fa-calendar-days text-[#A1887F]"></i> ì§€ë‚œ ê¸°ë¡ ë‹¬ë ¥ìœ¼ë¡œ ë³´ê¸°
                    </button>
                </div>
            );
        };

        // í¸ì§€ ì“°ê¸° íƒ­ (ìŠ¤ìƒ· ë°˜ì˜)
        const LetterWrite = ({ user, settings, tracker }) => {
            return (
                <div className="p-6 flex flex-col h-full">
                    <div className="flex gap-2 mb-6">
                        <div className="bg-white px-4 py-2 rounded-full shadow-sm text-sm flex items-center gap-2"><i className="fa-solid fa-camera opacity-30"></i> ì‚¬ì§„</div>
                        {tracker && <div className="bg-white px-4 py-2 rounded-full shadow-sm text-sm flex items-center gap-2 text-gray-500">
                            ğŸŒ™ {tracker.sleep}h {tracker.mood} {tracker.condition}
                        </div>}
                    </div>
                    <h3 className="text-center text-lg mb-4 text-gray-400">To. {settings.characterName}</h3>
                    <div className="ddb-card flex-1">
                        <textarea className="lined-paper" placeholder="ì—¬ê¸°ì— ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." />
                    </div>
                    <button className="w-full bg-[#8D7B71] text-white py-5 rounded-2xl font-bold shadow-lg mt-6">í¸ì§€ ë³´ë‚´ê¸°</button>
                </div>
            );
        };

        // ìº˜ë¦°ë” íƒ­ (ìŠ¤ìƒ· ë°˜ì˜)
        const CalendarView = ({ letters }) => {
            const today = new Date();
            const [viewDate] = useState(new Date());
            return (
                <div className="p-6">
                    <div className="text-center mb-6">
                        <span className="text-gray-300 mr-4">er 2025</span>
                        <span className="text-xl font-bold text-[#8D7B71]">December 2025</span>
                        <span className="text-gray-300 ml-4">Januar</span>
                    </div>
                    <div className="ddb-card p-6">
                        <div className="grid grid-cols-7 gap-y-6 text-center">
                            {['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d=><div key={d} className="text-[#A1887F] text-xs">{d}</div>)}
                            {Array.from({length: 31}, (_, i) => i + 1).map(d => {
                                const hasLetter = letters.some(l => new Date(l.date).getDate() === d);
                                return (
                                    <div key={d} className={`relative aspect-square flex items-center justify-center text-sm font-bold ${d === 26 ? 'bg-gray-100 rounded-xl' : ''}`}>
                                        {d}
                                        {hasLetter && <img src={`${STAMP_BASE_URL}stamp_00028.png`} className="absolute inset-0 w-full h-full object-contain p-1" />}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const Login = ({ onLogin }) => (
            <div className="app-shell items-center justify-center p-10 text-center">
                <h1 className="text-4xl font-bold text-[#8D6E63] mb-8 font-serif">DIRI-Penpal</h1>
                <button onClick={onLogin} className="w-full bg-white border py-4 rounded-3xl flex items-center justify-center gap-3 shadow-md">
                    êµ¬ê¸€ ë¡œê·¸ì¸ ì‹œì‘
                </button>
            </div>
        );

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
