<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DIRI-Penpal Diary</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap');
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Gowun Dodum', sans-serif; background-color: #F7F4EB; margin: 0; color: #5D4037; overflow: hidden; }
        
        .app-shell { 
            width: 100%; max-width: 480px; height: 100dvh; 
            display: flex; flex-direction: column; margin: 0 auto; 
            background-color: #F7F4EB; position: relative; overflow: hidden;
        }

        .main-content { 
            flex: 1; overflow-y: auto; padding: 20px;
            padding-bottom: 100px;
            -webkit-overflow-scrolling: touch;
        }

        .bottom-nav { 
            position: absolute; bottom: 0; width: 100%; 
            height: calc(85px + env(safe-area-inset-bottom));
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; align-items: flex-start;
            padding-top: 15px; border-top: 1px solid rgba(141, 110, 99, 0.1);
            padding-bottom: env(safe-area-inset-bottom); z-index: 100;
        }

        .lined-paper { 
            background-image: linear-gradient(transparent 39px, #eee 40px); 
            background-size: 100% 40px; line-height: 40px; border: none; 
            resize: none; width: 100%; min-height: 400px; font-size: 18px; 
            outline: none; background-color: transparent;
        }

        .ddb-card { background: white; border-radius: 28px; padding: 20px; box-shadow: 0 4px 15px rgba(141, 110, 99, 0.05); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; width: 20%; color: #A1887F; }
        .nav-item.active { color: #5D4037; }
        .nav-item.active i { background: #EFEBE9; width: 50px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 18px; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .calendar-day { aspect-ratio: 1/1.2; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; position: relative; }
        .stamp-overlay { position: absolute; inset: 0; padding: 2px; z-index: 1; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBhgHe856C8jJUsW_3gjJSOO3mlQXDee-c",
            authDomain: "diri-penpal-diary.firebaseapp.com",
            projectId: "diri-penpal-diary",
            storageBucket: "diri-penpal-diary.firebasestorage.app",
            messagingSenderId: "587612499384",
            appId: "1:587612499384:web:8c1f491372cb112050334d"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ‚úÖ ÏàòÏ†ïÎê®: ÍπÉÌóàÎ∏å Ï£ºÏÜå ÎåÄÏã† Î°úÏª¨ Ìè¥Îçî Í≤ΩÎ°ú ÏÇ¨Ïö© (Ìõ®Ïî¨ ÏïàÏ†ïÏ†Å)
        const STAMP_BASE_URL = "stamps/"; 
        const getStampUrl = (num) => `${STAMP_BASE_URL}stamp_${String(num).padStart(5, '0')}.png`;

        const App = () => {
            const [user, setUser] = useState(null);
            const [isBooting, setIsBooting] = useState(true);
            const [activeTab, setActiveTab] = useState('write'); 
            const [data, setData] = useState({ letters: [], trackers: [] });
            const [settings] = useState({ characterName: 'ÌûàÏöîÎ¶¨' });

            const loadData = useCallback(async (uid) => {
                const [l, t] = await Promise.all([
                    db.collection('users').doc(uid).collection('letters').orderBy('date', 'desc').get(),
                    db.collection('users').doc(uid).collection('trackers').orderBy('date', 'desc').limit(1).get()
                ]);
                setData({
                    letters: l.docs.map(d => ({id: d.id, ...d.data()})),
                    trackers: t.docs.map(d => ({id: d.id, ...d.data()}))
                });
            }, []);

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        await loadData(u.uid);
                    }
                    setIsBooting(false);
                });
                return unsub;
            }, [loadData]);

            if (isBooting) return null;
            if (!user) return <div className="app-shell flex items-center justify-center"><button onClick={() => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())} className="bg-white p-4 rounded-2xl shadow-md font-bold">Î°úÍ∑∏Ïù∏ ÏãúÏûë</button></div>;

            return (
                <div className="app-shell">
                    <div className="main-content">
                        {activeTab === 'today' && <TodayView letters={data.letters} name={settings.characterName} />}
                        {activeTab === 'tracker' && <TrackerView user={user} onSave={() => loadData(user.uid)} />}
                        {activeTab === 'write' && <LetterView name={settings.characterName} tracker={data.trackers[0]} />}
                        {activeTab === 'calendar' && <CalendarView letters={data.letters} />}
                    </div>

                    <nav className="bottom-nav">
                        <NavItem icon="fa-mobile-screen" label="Ïò§Îäò" active={activeTab==='today'} onClick={()=>setActiveTab('today')} />
                        <NavItem icon="fa-clipboard-list" label="Í∏∞Î°ù" active={activeTab==='tracker'} onClick={()=>setActiveTab('tracker')} />
                        <NavItem icon="fa-pen-nib" label="Ìé∏ÏßÄ" active={activeTab==='write'} onClick={()=>setActiveTab('write')} />
                        <NavItem icon="fa-calendar" label="Ï∫òÎ¶∞Îçî" active={activeTab==='calendar'} onClick={()=>setActiveTab('calendar')} />
                        <NavItem icon="fa-ellipsis" label="More" active={activeTab==='more'} onClick={()=>setActiveTab('more')} />
                    </nav>
                </div>
            );
        };

        const NavItem = ({ icon, label, active, onClick }) => (
            <button onClick={onClick} className={`nav-item ${active ? 'active' : ''}`}>
                <i className={`fa-solid ${icon} text-lg mb-1`}></i>
                <span className="text-[10px] font-bold">{label}</span>
            </button>
        );

        const LetterView = ({ name, tracker }) => (
            <div className="space-y-6">
                <div className="flex gap-2 mb-4">
                    <div className="bg-white px-4 py-2 rounded-full shadow-sm text-xs text-gray-400 flex items-center gap-2"><i className="fa-solid fa-camera"></i> ÏÇ¨ÏßÑ</div>
                    {tracker && <div className="bg-white px-4 py-2 rounded-full shadow-sm text-xs text-gray-500 flex items-center gap-2">
                        üåô {tracker.sleep}h {tracker.mood} {tracker.condition}
                    </div>}
                </div>
                <h2 className="text-center text-gray-400 text-lg">To. {name}</h2>
                <div className="ddb-card min-h-[450px]">
                    <textarea className="lined-paper" placeholder="ÎßàÏùåÏùÑ Ï†ÑÌï¥Î≥¥ÏÑ∏Ïöî..." />
                </div>
                <button className="w-full bg-[#8D7B71] text-white py-5 rounded-[24px] font-bold shadow-lg">Ìé∏ÏßÄ Î≥¥ÎÇ¥Í∏∞</button>
            </div>
        );

        const CalendarView = ({ letters }) => (
            <div className="space-y-6">
                <div className="text-center mb-4">
                    <span className="text-gray-200 text-xs uppercase mr-2 font-bold">Nov 2025</span>
                    <span className="text-xl font-bold text-[#8D6E63] uppercase">December 2025</span>
                    <span className="text-gray-200 text-xs uppercase ml-2 font-bold">Jan 2026</span>
                </div>
                <div className="ddb-card p-4">
                    <div className="calendar-grid">
                        {['SUN','MON','TUE','WED','THU','FRI','SAT'].map(d => <div key={d} className="text-[9px] text-orange-200 font-bold text-center mb-4">{d}</div>)}
                        {Array.from({length: 31}, (_, i) => i + 1).map(d => {
                            const hasLetter = letters.some(l => new Date(l.date).getDate() === d);
                            return (
                                <div key={d} className={`calendar-day ${d === 26 ? 'bg-gray-100 rounded-xl' : ''}`}>
                                    <span className="z-10">{d}</span>
                                    {hasLetter && <div className="stamp-overlay"><img src={getStampUrl(28)} className="w-full h-full object-contain" /></div>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            </div>
        );

        const TrackerView = ({ user, onSave }) => {
            const [sleep, setSleep] = useState(7.0);
            const save = async () => {
                await db.collection('users').doc(user.uid).collection('trackers').add({ sleep, mood: 'Î≥¥ÌÜµ', condition: 'Î≥¥ÌÜµ', date: new Date().toISOString() });
                alert("Í∏∞Î°ù ÏôÑÎ£å"); onSave();
            };
            return (
                <div className="space-y-6">
                    <h2 className="text-center text-xl font-bold mt-4">Ïò§ÎäòÏùò Í∏∞Î°ù</h2>
                    <div className="ddb-card space-y-8">
                        {['Í∏∞Î∂Ñ','Ïª®ÎîîÏÖò','Ïö¥Îèô','ÎÇ†Ïî®'].map(t => (
                            <div key={t} className="flex justify-between items-center border-b border-gray-50 pb-4">
                                <span className="text-sm opacity-40">{t}</span><span className="bg-[#F9F7F2] px-3 py-1 rounded-lg text-xs font-bold text-gray-400">Î≥¥ÌÜµ</span>
                            </div>
                        ))}
                        <div className="space-y-4">
                            <div className="flex justify-between font-bold"><span>üåô ÏàòÎ©¥ ÏãúÍ∞Ñ</span><span className="text-[#8D6E63]">{sleep}h</span></div>
                            <input type="range" min="0" max="12" step="0.5" value={sleep} onChange={e=>setSleep(e.target.value)} className="w-full accent-[#8D6E63]" />
                        </div>
                    </div>
                    <button onClick={save} className="w-full bg-[#8D7B71] text-white py-5 rounded-[24px] font-bold shadow-lg">Í∏∞Î°ù Ï†ÄÏû•ÌïòÍ∏∞</button>
                </div>
            );
        };

        const TodayView = ({ letters, name }) => (
            <div className="p-4"><div className="ddb-card flex items-center gap-4"><div className="w-12 h-12 bg-gray-200 rounded-full" /><div><h4 className="font-bold">{name}</h4><p className="text-xs text-gray-400">"{letters[0]?.reply || "Î∞òÍ∞ÄÏõå!"}"</p></div></div></div>
        );

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
